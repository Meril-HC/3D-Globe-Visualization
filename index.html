<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Map with Hover and Highlight</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map {
      height: 100vh; /* Fullscreen height */
      width: 100%;
    }
    .leaflet-popup-content {
      font-size: 14px;
    }
    .highlight-country {
      color: red;
      weight: 3;
      fillOpacity: 0.1;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-geoman-free@2.13.0/dist/leaflet-geoman.min.js"></script>
  <script>
    // Initialize the map
    const map = L.map('map').setView([20, 0], 2); // Centered globally

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Load GeoJSON for country boundaries
    const geoJsonUrl = 'https://raw.githubusercontent.com/datasets/geo-boundaries-world-110m/master/countries.geojson';

    // Fetch product data and country boundaries
    Promise.all([
      fetch('./transformed_data.json').then(res => res.json()),
      fetch(geoJsonUrl).then(res => res.json())
    ]).then(([productData, geoJsonData]) => {
      const countryData = {};

      // Group products by country
      productData.forEach(item => {
        const { country } = item;

        if (!countryData[country]) {
          countryData[country] = { totalProducts: 0 };
        }

        countryData[country].totalProducts += 1;
      });

      // Style for highlighting country borders on hover
      const highlightStyle = {
        color: 'red',
        weight: 2,
        fillOpacity: 0.1
      };

      // Add GeoJSON layer to the map
      const geoJsonLayer = L.geoJson(geoJsonData, {
        style: {
          color: '#3388ff',
          weight: 1,
          fillOpacity: 0.2
        },
        onEachFeature: (feature, layer) => {
          const countryName = feature.properties.ADMIN;
          const totalProducts = countryData[countryName]?.totalProducts || 0;

          // Add hover effect for the country
          layer.on('mouseover', () => {
            layer.setStyle(highlightStyle);

            const popupContent = `
              <div style="text-align: center;">
                <h3>${countryName}</h3>
                <p><b>Total Products:</b> ${totalProducts}</p>
              </div>
            `;
            layer.bindPopup(popupContent).openPopup();
          });

          // Remove hover effect
          layer.on('mouseout', () => {
            geoJsonLayer.resetStyle(layer);
          });
        }
      }).addTo(map);

      // Add zoom handling for continuous maps
      map.on('zoomend', () => {
        const zoomLevel = map.getZoom();
        if (zoomLevel < 2) {
          map.setZoom(2); // Prevent zooming out too far
        }
      });
    }).catch(error => {
      console.error('Error loading data:', error);
    });
  </script>
</body>
</html>
